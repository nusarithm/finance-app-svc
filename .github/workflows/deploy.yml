name: Deploy to Render

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Trigger Render Deploy
    runs-on: ubuntu-latest
    env:
      # Map critical repo secrets (set these in GitHub Secrets)
      RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
      RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      SECRET_KEY: ${{ secrets.SECRET_KEY }}

    steps:
      - name: Validate required secrets
        run: |
          required=(RENDER_API_KEY RENDER_SERVICE_ID SUPABASE_URL SUPABASE_SERVICE_ROLE_KEY SECRET_KEY)
          missing=0
          for var in "${required[@]}"; do
            if [ -z "${!var}" ]; then
              echo "ERROR: $var is not set"
              missing=1
            fi
          done
          if [ "$missing" -eq 1 ]; then exit 1; fi

      - name: Trigger deploy via Render API
        id: render_deploy
        run: |
          set -e
          echo "Triggering deploy for Render service $RENDER_SERVICE_ID"
          resp=$(curl -s -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{"clearCache":true}')
          echo "Render response: $resp"
          echo "response=$resp" >> $GITHUB_OUTPUT

      - name: Show deploy status (optional)
        run: |
          echo "You can monitor the deployment in the Render dashboard: https://dashboard.render.com/services/$RENDER_SERVICE_ID"
